name: Docker Build and Deploy

on:
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
        -   name: Checkout Repository
            uses: actions/checkout@v4

        -   name: Login to Docker Hub
            uses: docker/login-action@v1
            with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}

        -   name: Copy .env file
            run: cp .env.example .env

        -   name: Build Docker Image
            run: docker build --build-arg ENV_FILE=.env -t brownei/lint-backend .

        -   name: Push Docker Image
            run: docker push brownei/lint-backend

    deploy:
        needs: build
        runs-on: self-hosted 
        steps:
            -   name: Pull image from Docker Hub
                run: docker pull brownei/lint-backend:latest

            -   name: Copy .env file to server
                uses: actions/upload-artifact@v3
                with:
                    name: env-file
                    path: .env

            -   name: Download .env file on server
                uses: actions/download-artifact@v3
                with:
                    name: env-file
                    path: /home/ec2-user/

            -   name: Delete old container
                run: docker rm -f lint-api  

            -   name: Run Docker Container
                run: docker run --env-file /home/ec2-user/.env -d -p 3131:3131 --name lint-api brownei/lint-backend
